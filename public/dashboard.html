<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rush Royale Stat Overlay</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Rush Royale Stat Overlay</h1>
    <p>powered by Raging Beasts</p>
    <h2 id="welcome-msg"></h2>

    <!-- Overlay URL Section -->
    <label for="overlay-url">Overlay URL:</label>
    <input type="text" id="overlay-url" readonly>
    <button onclick="copyToClipboard()">Copy</button>
    <p>Paste this into OBS as a Browser Source.</p>

    <!-- Stats Form Section -->
    <form id="stats-form">
      <div class="stats-box">
        <label for="total-crit">Total Critical Count</label>
        <input type="number" id="total-crit" placeholder="example" required>
      </div>
      <div class="stats-box">
        <label for="season-trophy-start">Season Trophy Start</label>
        <input type="number" id="season-trophy-start" placeholder="example" required>
      </div>
      <div class="stats-box">
        <label for="session-trophy-start">Session Trophy Start</label>
        <input type="number" id="session-trophy-start" placeholder="example" required>
      </div>
      <div class="stats-box">
        <label for="total-trophy-count">Total Trophy Count</label>
        <input type="number" id="total-trophy-count" placeholder="example" required>
      </div>
      <div class="stats-box">
        <label for="session-wins">Session Wins</label>
        <input type="number" id="session-wins" placeholder="example" required>
      </div>
      <div class="stats-box">
        <label for="session-losses">Session Losses</label>
        <input type="number" id="session-losses" placeholder="example" required>
      </div>
      <button type="submit">Save Changes</button>
    </form>

    <!-- Logout Button -->
    <button id="logout-btn" class="logout-btn">Logout</button>

  </div>

  <script>
    // Auto-detect redirect after logout (same logic as login)
    const LOGOUT_REDIRECT = window.OAUTH_REDIRECT || `${window.location.origin}/index.html`;

    // Logout Function
    async function logout() {
      try {
        await sb.auth.signOut();
        window.location.href = LOGOUT_REDIRECT;
      } catch (err) {
        console.error("Logout failed:", err);
        alert("Logout error, check console.");
      }
    }

    // Setup logout button event
    document.getElementById("logout-btn").addEventListener("click", logout);

    // Auto-fill user details after login
    if (!window.sb) {
      alert("Supabase not loaded â€” check config.js");
      throw new Error("Supabase missing");
    }

    async function displayUserInfo() {
      const user = sb.auth.user();
      if (user) {
        document.getElementById("welcome-msg").textContent = `Welcome back, ${user.user_metadata.name} (${user.provider})`;
        const overlayUrl = `${window.location.origin}/overlay/${user.id}`;
        document.getElementById("overlay-url").value = overlayUrl;
      } else {
        alert("User not authenticated.");
        window.location.href = `${window.location.origin}/index.html`;
      }
    }

    // Run display function on load
    displayUserInfo();

    // Copy overlay URL to clipboard
    function copyToClipboard() {
      const overlayUrl = document.getElementById("overlay-url");
      overlayUrl.select();
      document.execCommand("copy");
      alert("Overlay URL copied to clipboard!");
    }

    // Handle the stats form submission (for saving data)
    document.getElementById("stats-form").addEventListener("submit", function(event) {
      event.preventDefault();

      // Collect form data
      const statsData = {
        totalCrit: document.getElementById("total-crit").value,
        seasonTrophyStart: document.getElementById("season-trophy-start").value,
        sessionTrophyStart: document.getElementById("session-trophy-start").value,
        totalTrophyCount: document.getElementById("total-trophy-count").value,
        sessionWins: document.getElementById("session-wins").value,
        sessionLosses: document.getElementById("session-losses").value
      };

      // Save data to Supabase (assuming you've set up a table in Supabase to store this info)
      const { error } = await sb.from("creator_stats").upsert([
        { 
          uid: sb.auth.user().id, // User ID from Supabase session
          ...statsData
        ]
      ]);

      if (error) {
        console.error("Error saving stats:", error);
        alert("Failed to save stats");
      } else {
        alert("Stats saved successfully!");
      }
    });
  </script>
</body>
</html>
